#define LAYER_BASE 0
#define LAYER_SYMB 1
#define LAYER_PWR 2
#define LAYER_NAV 3
#define LAYER_NMPAD 4
#define LAYER_FN 5

/* Increase mouse cursor speed 3x (default is 600) */
#define ZMK_MOUSE_DEFAULT_MOVE_VAL 1800
/* Double scroll wheel speed (default is 10) */
#define ZMK_MOUSE_DEFAULT_SCRL_VAL 20

#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/mouse.h>
#include <dt-bindings/zmk/outputs.h>

/* Mouse acceleration: starts slow, smoothly ramps to max speed over 500ms */
&mmv {
	delay-ms = <0>;
	time-to-max-speed-ms = <500>;
	acceleration-exponent = <2>;
};

/ {
	behaviors {
		lt_pwr: layer_tap_pwr {
			compatible = "zmk,behavior-hold-tap";
			#binding-cells = <2>;
			flavor = "balanced";
			tapping-term-ms = <280>;
			quick-tap-ms = <175>;
			bindings = <&mo>, <&kp>;
		};
		hm: homerow_mod {
			compatible = "zmk,behavior-hold-tap";
			#binding-cells = <2>;
			flavor = "tap-preferred";
			tapping-term-ms = <280>;
			quick-tap-ms = <175>;
			require-prior-idle-ms = <200>;
			bindings = <&kp>, <&kp>;
		};
		/* Hold backspace = delete word (Option+Backspace on macOS) */
		bspc_word: backspace_word {
			compatible = "zmk,behavior-hold-tap";
			#binding-cells = <2>;
			flavor = "balanced";
			tapping-term-ms = <300>;
			quick-tap-ms = <0>;
			bindings = <&kp>, <&kp>;
		};
		/* Hold-tap for Cmd+key: hold = Cmd+key, tap = key */
		ht_cmd: hold_tap_cmd {
			compatible = "zmk,behavior-hold-tap";
			#binding-cells = <2>;
			flavor = "tap-preferred";
			tapping-term-ms = <200>;
			quick-tap-ms = <0>;
			bindings = <&kp>, <&kp>;
		};
		/* Tap-dance + hold for Cmd shortcuts: tap=key, tap-tap-hold=Cmd+key */
		/* S key: tap=s, double-tap-hold=Cmd+S (save) */
		td_s: tap_dance_s {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <200>;
			bindings = <&kp S>, <&ht_cmd LG(S) S>;
		};
		/* A key: tap=a, double-tap-hold=Cmd+A (select all) */
		td_a: tap_dance_a {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <200>;
			bindings = <&kp A>, <&ht_cmd LG(A) A>;
		};
		/* Z key: tap=z, double-tap-hold=Cmd+Z (undo) */
		td_z: tap_dance_z {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <200>;
			bindings = <&kp Z>, <&ht_cmd LG(Z) Z>;
		};
		/* X key: tap=x, double-tap-hold=Cmd+X (cut) */
		td_x: tap_dance_x {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <200>;
			bindings = <&kp X>, <&ht_cmd LG(X) X>;
		};
		/* C key: tap=c, double-tap-hold=Cmd+C (copy) */
		td_c: tap_dance_c {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <200>;
			bindings = <&kp C>, <&ht_cmd LG(C) C>;
		};
		/* V key: tap=v, double-tap-hold=Cmd+V (paste) */
		td_v: tap_dance_v {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <200>;
			bindings = <&kp V>, <&ht_cmd LG(V) V>;
		};
		/* F key: tap=f, double-tap-hold=Cmd+F (find) */
		td_f: tap_dance_f {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <200>;
			bindings = <&kp F>, <&ht_cmd LG(F) F>;
		};
		/* W key: tap=w, double-tap-hold=Cmd+W (close tab) */
		td_w: tap_dance_w {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <200>;
			bindings = <&kp W>, <&ht_cmd LG(W) W>;
		};
		/* T key: tap=t, double-tap-hold=Cmd+T (new tab) */
		td_t: tap_dance_t {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <200>;
			bindings = <&kp T>, <&ht_cmd LG(T) T>;
		};
		/* Q key: tap=q, double-tap-hold=Cmd+Q (quit) */
		td_q: tap_dance_q {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <200>;
			bindings = <&kp Q>, <&ht_cmd LG(Q) Q>;
		};
		td_shift_caps: tap_dance_shift_caps {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <200>;
			bindings = <&kp LEFT_SHIFT>, <&kp CAPSLOCK>;
		};
		arrow_left: arrow_word_left {
			compatible = "zmk,behavior-hold-tap";
			#binding-cells = <2>;
			flavor = "balanced";
			tapping-term-ms = <200>;
			quick-tap-ms = <150>;
			bindings = <&kp>, <&kp>;
		};
		arrow_right: arrow_word_right {
			compatible = "zmk,behavior-hold-tap";
			#binding-cells = <2>;
			flavor = "balanced";
			tapping-term-ms = <200>;
			quick-tap-ms = <150>;
			bindings = <&kp>, <&kp>;
		};
	};

	keymap {
		compatible = "zmk,keymap";
		layer_0 {
			bindings = <
				&none
				&gresc           &kp NUMBER_1 &kp NUMBER_2 &kp NUMBER_3 &kp NUMBER_4        &kp NUMBER_5         &mo LAYER_FN             &mo LAYER_FN      &kp NUMBER_6             &kp NUMBER_7   &kp NUMBER_8 &kp NUMBER_9   &kp NUMBER_0    &bspc_word LA(BACKSPACE) BACKSPACE
				&kp TAB          &td_q        &td_w        &kp E        &kp R               &td_t                &kp C_PLAY_PAUSE         &kp C_VOL_UP      &kp Y                    &kp U          &kp I        &kp O          &kp P           &kp BACKSLASH
				&mt LCTRL ESCAPE &hm LCTRL A  &hm LALT S   &hm LGUI D   &hm LSHIFT F        &kp G                                                           &kp H                    &hm RSHIFT J   &hm RGUI K   &hm RALT L     &hm RCTRL SEMICOLON &kp SINGLE_QUOTE
				&td_shift_caps   &td_z        &td_x        &td_c        &td_v               &kp B                &kp C_NEXT               &kp C_VOL_DN      &kp N                    &kp M          &kp COMMA    &kp PERIOD     &kp SLASH       &kp RIGHT_SHIFT
				&kp LEFT_CONTROL &kp LEFT_ALT &kp LEFT_GUI &mkp LCLK    &mkp RCLK                                                                                                    &arrow_left LC(LEFT) LEFT_ARROW &kp UP_ARROW &kp DOWN_ARROW &arrow_right LC(RIGHT) RIGHT_ARROW &kp RETURN
				                                                                            &kp DELETE           &kp C_PLAY_PAUSE         &kp C_NEXT        &kp DELETE
				                                                        &lt LAYER_NAV SPACE &lt LAYER_PWR RETURN &kp HOME                 &kp END           &bspc_word LA(BACKSPACE) BACKSPACE &lt LAYER_NAV SPACE
				                                                                                                 &lt LAYER_NMPAD QUESTION &lt LAYER_SYMB PERIOD
			>;
		};
		layer_1 {
			bindings = <
				&none
				&none  &kp TILDE      &none           &none         &none            &none  &none &none &none  &none                &none                 &none         &kp GRAVE     &trans
				&none  &none          &kp DOLLAR      &kp HASH      &kp CARET        &none  &none &none &none  &kp UNDERSCORE       &kp AT_SIGN           &kp PERCENT   &none         &none
				&none  &kp MINUS      &kp ASTERISK    &kp PIPE      &kp AMPERSAND    &none              &none  &kp LEFT_PARENTHESIS &kp RIGHT_PARENTHESIS &kp PLUS      &kp EQUAL     &kp COLON
				&none  &kp LEFT_BRACE &kp RIGHT_BRACE &kp LESS_THAN &kp GREATER_THAN &none  &none &none &none  &kp LEFT_BRACKET     &kp RIGHT_BRACKET     &kp EXCLAMATION &kp QUESTION &none
				&trans &trans         &trans          &trans        &trans                                     &trans               &trans                &trans        &trans        &trans
				                                                                     &none  &none &none &none
				                                                    &trans           &trans &none &none &trans &trans
				                                                                            &none &none
			>;
		};
		layer_2 {
			bindings = <
				&none
				&none &kp LC(Z)   &kp LC(LS(Z))      &kp LC(LS(NUMBER_4)) &none        &none                    &none &none &none &none                  &none          &none           &none                   &kp LC(BACKSPACE)
				&none &kp LC(A)   &kp LS(TAB)        &kp TAB              &none        &none                    &none &none &none &kp LC(LEFT)           &kp UP_ARROW   &kp LC(RIGHT)   &kp PAGE_UP             &kp LC(DELETE)
				&none &sk LCTRL   &sk LSHIFT         &sk LALT             &sk LGUI     &sk LC(LS(LA(LEFT_GUI)))             &none &kp LEFT_ARROW         &kp DOWN_ARROW &kp RIGHT_ARROW &kp PAGE_DOWN           &none
				&none &kp LC(X)        &kp LC(C)      &kp LC(V)    &none        &none                    &none &none &none &kp HOME               &none          &kp END         &none                   &none
				&none &none            &none          &trans       &trans                                                  &kp LS(LA(LEFT_ARROW)) &trans         &trans          &kp LS(LA(RIGHT_ARROW)) &none
				                                                                &none                    &none &none &none
				                                                   &none        &none                    &none &none &none &none
				                                                                                         &none &none
			>;
		};
		layer_3 {
			bindings = <
				&none
				&none &none &msc SCRL_UP   &none          &mkp RCLK       &none &none &none &none &mkp RCLK      &none          &msc SCRL_UP    &none  &none
				&none &none &msc SCRL_DOWN &mmv MOVE_UP   &mkp LCLK       &none &none &none &none &mkp LCLK      &mmv MOVE_UP   &msc SCRL_DOWN  &none  &none
				&none &none &mmv MOVE_LEFT &mmv MOVE_DOWN &mmv MOVE_RIGHT &none             &none &mmv MOVE_LEFT &mmv MOVE_DOWN &mmv MOVE_RIGHT &none  &none
				&none &none &none          &none          &none           &none &none &none &none &none          &none          &none           &none  &none
				&none &none &none          &mkp LCLK      &mkp RCLK                               &trans         &trans         &trans          &trans &none
				                                                          &none &none &none &none
				                                          &none           &none &none &none &none &none
				                                                                &none &none
			>;
		};
		layer_4 {
			bindings = <
				&none
				&none   &kp F1    &kp F2       &kp F3       &kp F4       &kp F5       &kp F6               &kp F7               &kp F8       &kp F9       &kp F10      &kp F11      &kp F12      &trans
				&kp TAB &kp SLASH &kp NUMBER_7 &kp NUMBER_8 &kp NUMBER_9 &kp ASTERISK &none                &none                &kp SLASH    &kp NUMBER_7 &kp NUMBER_8 &kp NUMBER_9 &kp ASTERISK &none
				&none   &kp MINUS &kp NUMBER_4 &kp NUMBER_5 &kp NUMBER_6 &kp PLUS                                              &kp MINUS    &kp NUMBER_4 &kp NUMBER_5 &kp NUMBER_6 &kp PLUS     &none
				&none   &none     &kp NUMBER_1 &kp NUMBER_2 &kp NUMBER_3 &kp EQUAL    &kp C_BRIGHTNESS_DEC &kp C_BRIGHTNESS_INC &none        &kp NUMBER_1 &kp NUMBER_2 &kp NUMBER_3 &kp EQUAL    &none
				&none   &none     &kp PERIOD   &kp NUMBER_0 &kp COMMA                                                                       &kp PERIOD   &kp NUMBER_0 &kp COMMA    &none        &trans
				                                                      &none  &none                &none                &none
				                                         &none        &none  &none                &none                &none  &none
				                                                             &none                &none
			>;
		};
		layer_5 {
			bindings = <
				&bootloader
				&bt BT_SEL 0 &bt BT_SEL 1 &bt BT_SEL 2 &bt BT_SEL 3 &bt BT_SEL 4 &none &none &none &none &none   &none   &none   &none   &bootloader
				&out OUT_USB &kp F1       &kp F2       &kp F3       &kp F4       &none &none &none &none &kp F13 &kp F14 &kp F15 &kp F16 &none
				&out OUT_BLE &kp F5       &kp F6       &kp F7       &kp F8       &none             &none &kp F17 &kp F18 &kp F19 &kp F20 &none
				&none        &kp F9       &kp F10      &kp F11      &kp F12      &none &none &none &none &kp F21 &kp F22 &kp F23 &kp F24 &bt BT_CLR
				&none        &none        &none        &none        &none                                &none   &none   &none   &none   &none
				                                                                 &none &none &none &none
				                                                    &none        &none &none &none &none &none
				                                                                       &none &none
			>;
		};
	};
};
